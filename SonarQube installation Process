# 1. Update system & install Java
sudo apt update -y
sudo apt upgrade -y
sudo apt install openjdk-17-jdk unzip -y

# 2. Create user & download SonarQube
sudo useradd -r -s /bin/false sonar
cd /opt
sudo wget https://binaries.sonarsource.com/Distribution/sonarqube/sonarqube-10.2.0.77691.zip
sudo unzip sonarqube-10.2.0.77691.zip
sudo mv sonarqube-10.2.0.77691 sonarqube
sudo chown -R sonar:sonar sonarqube

# 3. Install PostgreSQL & create DB
sudo apt install postgresql -y
sudo -u postgres psql -c "CREATE DATABASE sonar;"
sudo -u postgres psql -c "CREATE USER sonar_user WITH ENCRYPTED PASSWORD 'sonarpass';"
sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE sonar TO sonar_user;"

# 4. Configure SonarQube DB (edit sonar.properties manually)
# sonar.jdbc.username=sonar_user
# sonar.jdbc.password=sonarpass
# sonar.jdbc.url=jdbc:postgresql://localhost/sonar

# 5. Setup systemd & start service
sudo nano /etc/systemd/system/sonarqube.service   # add service config
sudo systemctl daemon-reload
sudo systemctl start sonarqube
sudo systemctl enable sonarqube
sudo ufw allow 9000
